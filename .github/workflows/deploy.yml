name: Deploy API to Server

on:
  push:
    branches: [master]

jobs:
  deploy:
    runs-on: windows-latest

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup .NET
        uses: actions/setup-dotnet@v4
        with:
          dotnet-version: "8.0.x"

      # Build Backend Only
      - name: Build API
        run: |
          dotnet publish Endpoints/Api/Api.csproj -c Release -o ./publish/api

      # Create deployment folder
      - name: Prepare deployment
        run: |
          # Create folders
          mkdir deployment

          # Copy API files to root
          xcopy /E /I /Y "publish\api\*" "deployment\"

          # Create simple appsettings.json
          echo '{
            "ConnectionStrings": {
              "DefaultConnection": "Server=localhost\\\\SQLEXPRESS;Database=pardisto_api;User Id=ewan;Password=0gH!_kE2buHfcb0w;TrustServerCertificate=True;Encrypt=False;"
            },
            "JwtSettings": {
              "Key": "n8B5C1yK4mYx7DqRZQ0pVJm0r2KzF+T9aA1XcH3sWlU=",
              "Issuer": "PardisAcademy",
              "Audience": "PardisAcademyUsers"
            },
            "AllowedHosts": "*"
          }' > deployment\appsettings.json

          # Create web.config for API
          echo '<?xml version="1.0" encoding="utf-8"?>
          <configuration>
            <system.webServer>
              <handlers>
                <add name="aspNetCore" path="*" verb="*" modules="AspNetCoreModuleV2" resourceType="Unspecified" />
              </handlers>
              <aspNetCore processPath="dotnet" arguments=".\Api.dll" stdoutLogEnabled="true" stdoutLogFile=".\logs\stdout" hostingModel="inprocess">
                <environmentVariables>
                  <environmentVariable name="ASPNETCORE_ENVIRONMENT" value="Production" />
                </environmentVariables>
              </aspNetCore>
            </system.webServer>
          </configuration>' > deployment\web.config

          # Create app_offline.htm to stop the application during deployment
          # Note: This will be uploaded separately, not included in main deployment

      # Step 1: Upload app_offline.htm to stop the application
      - name: Stop Application
        run: |
          # Create a simple app_offline.htm file
          echo '<!DOCTYPE html>
          <html>
          <head>
              <title>Application Offline</title>
              <meta charset="utf-8" />
          </head>
          <body>
              <h1>Application is being updated</h1>
              <p>The application is currently being updated. Please try again in a few moments.</p>
          </body>
          </html>' > app_offline.htm

          # Upload only app_offline.htm via FTP script
          echo 'open ftp.api.pardistous.ir
          ewan
          mahan1384@
          put app_offline.htm
          quit' > ftp_stop.txt
          ftp -s:ftp_stop.txt
          del ftp_stop.txt
          del app_offline.htm

      # Wait for application to stop completely
      - name: Wait for application to stop
        run: |
          Write-Host "Waiting for application to stop completely..."
          Start-Sleep -Seconds 45
          Write-Host "Application should be stopped now..."

      # Step 2: Deploy all files (now that app is offline)
      - name: Deploy to Server
        uses: SamKirkland/FTP-Deploy-Action@v4.3.4
        with:
          server: ftp.api.pardistous.ir
          username: ewan
          password: mahan1384@
          local-dir: ./deployment/
          server-dir: /
          # Add retry and timeout settings
          timeout: 60000
        continue-on-error: true
        id: deploy_attempt_1

      # Retry deployment if first attempt failed
      - name: Retry Deploy if Failed
        if: steps.deploy_attempt_1.outcome == 'failure'
        run: |
          Write-Host "First deployment failed, waiting longer and retrying..."
          Start-Sleep -Seconds 60

      - name: Deploy to Server (Retry)
        if: steps.deploy_attempt_1.outcome == 'failure'
        uses: SamKirkland/FTP-Deploy-Action@v4.3.4
        with:
          server: ftp.api.pardistous.ir
          username: ewan
          password: mahan1384@
          local-dir: ./deployment/
          server-dir: /
          timeout: 120000

      # Step 3: Remove app_offline.htm to start the application
      - name: Start Application
        run: |
          # Create a temporary script to delete app_offline.htm via FTP
          echo 'open ftp.api.pardistous.ir
          ewan
          mahan1384@
          delete app_offline.htm
          quit' > ftp_delete.txt
          ftp -s:ftp_delete.txt
          del ftp_delete.txt

      # Simple health check
      - name: Check if deployed
        run: |
          Write-Host "Waiting for application to start..."
          Start-Sleep -Seconds 60

          $maxAttempts = 5
          $attempt = 1

          while ($attempt -le $maxAttempts) {
            try {
              Write-Host "Health check attempt $attempt of $maxAttempts"
              $response = Invoke-WebRequest -Uri "https://api.pardistous.ir/api/health" -UseBasicParsing -TimeoutSec 15
              if ($response.StatusCode -eq 200) {
                Write-Host "✅ API is working! Deployment successful!"
                exit 0
              }
            } catch {
              Write-Host "⚠️ Attempt $attempt failed: $($_.Exception.Message)"
            }
            
            if ($attempt -lt $maxAttempts) {
              Write-Host "Waiting 30 seconds before next attempt..."
              Start-Sleep -Seconds 30
            }
            $attempt++
          }

          Write-Host "❌ API health check failed after $maxAttempts attempts"
          Write-Host "The deployment may still be successful, but the API is not responding yet"
