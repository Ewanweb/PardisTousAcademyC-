name: Deploy API to Server

on:
  workflow_dispatch: # Ø§Ù…Ú©Ø§Ù† Ø§Ø¬Ø±Ø§ÛŒ Ø¯Ø³ØªÛŒ

jobs:
  deploy:
    runs-on: windows-latest

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup .NET
        uses: actions/setup-dotnet@v4
        with:
          dotnet-version: "9.0.x"

      # Build Backend Only
      - name: Build API
        run: |
          Write-Host "ğŸ”¨ Ø´Ø±ÙˆØ¹ Build..." -ForegroundColor Cyan
          dotnet publish Endpoints/Api/Api.csproj -c Release -o ./publish/api
          Write-Host "âœ… Build ØªÚ©Ù…ÛŒÙ„ Ø´Ø¯" -ForegroundColor Green

      # Create deployment folder
      - name: Prepare deployment
        run: |
          Write-Host "ğŸ“¦ Ø¢Ù…Ø§Ø¯Ù‡â€ŒØ³Ø§Ø²ÛŒ ÙØ§ÛŒÙ„â€ŒÙ‡Ø§..." -ForegroundColor Cyan

          # Create folders
          mkdir deployment

          # Copy API files to root
          xcopy /E /I /Y "publish\api\*" "deployment\"

          # Create appsettings.json
          @"
          {
            "ConnectionStrings": {
              "DefaultConnection": "Server=localhost;Database=pardisto_api;User Id=mahan;Password=ewan1384@;TrustServerCertificate=True;"
            },
            "JwtSettings": {
              "Key": "n8B5C1yK4mYx7DqRZQ0pVJm0r2KzF+T9aA1XcH3sWlU=",
              "Issuer": "PardisAcademy",
              "Audience": "PardisAcademyUsers"
            },
            "AllowedHosts": "*",
            "Logging": {
              "LogLevel": {
                "Default": "Information",
                "Microsoft.AspNetCore": "Warning"
              }
            }
          }
          "@ | Out-File -FilePath "deployment\appsettings.json" -Encoding UTF8

          # Create web.config
          @"
          <?xml version="1.0" encoding="utf-8"?>
          <configuration>
            <system.webServer>
              <handlers>
                <add name="aspNetCore" path="*" verb="*" modules="AspNetCoreModuleV2" resourceType="Unspecified" />
              </handlers>
              <aspNetCore processPath="dotnet" arguments=".\Api.dll" stdoutLogEnabled="true" stdoutLogFile=".\logs\stdout" hostingModel="inprocess">
                <environmentVariables>
                  <environmentVariable name="ASPNETCORE_ENVIRONMENT" value="Production" />
                </environmentVariables>
              </aspNetCore>
            </system.webServer>
          </configuration>
          "@ | Out-File -FilePath "deployment\web.config" -Encoding UTF8

          Write-Host "âœ… ÙØ§ÛŒÙ„â€ŒÙ‡Ø§ Ø¢Ù…Ø§Ø¯Ù‡ Ø´Ø¯Ù†Ø¯" -ForegroundColor Green

      # Deploy to Server
      - name: Deploy to Server
        uses: SamKirkland/FTP-Deploy-Action@v4.3.4
        with:
          server: ftp.api.pardistous.ir
          username: ewan
          password: mahan1384@
          local-dir: ./deployment/
          server-dir: /
          timeout: 120000

      # Health check
      - name: Health Check
        run: |
          Write-Host "ğŸ¥ ØªØ³Øª Ø³Ù„Ø§Ù…Øª API..." -ForegroundColor Cyan
          Start-Sleep -Seconds 45

          $maxAttempts = 3
          $attempt = 1

          while ($attempt -le $maxAttempts) {
            try {
              Write-Host "ğŸ” ØªÙ„Ø§Ø´ $attempt Ø§Ø² $maxAttempts" -ForegroundColor Yellow
              $response = Invoke-WebRequest -Uri "https://api.pardistous.ir/api/health" -UseBasicParsing -TimeoutSec 15
              if ($response.StatusCode -eq 200) {
                Write-Host "âœ… API Ú©Ø§Ø± Ù…ÛŒâ€ŒÚ©Ù†Ù‡! Ø¯ÛŒÙ¾Ù„ÙˆÛŒ Ù…ÙˆÙÙ‚ Ø¨ÙˆØ¯!" -ForegroundColor Green
                Write-Host "ğŸŒ Ø¢Ø¯Ø±Ø³: https://api.pardistous.ir" -ForegroundColor Cyan
                exit 0
              }
            } catch {
              Write-Host "âš ï¸ ØªÙ„Ø§Ø´ $attempt Ù†Ø§Ù…ÙˆÙÙ‚: $($_.Exception.Message)" -ForegroundColor Red
            }
            
            if ($attempt -lt $maxAttempts) {
              Write-Host "â³ ØµØ¨Ø± 30 Ø«Ø§Ù†ÛŒÙ‡..." -ForegroundColor Yellow
              Start-Sleep -Seconds 30
            }
            $attempt++
          }

          Write-Host "âŒ ØªØ³Øª Ø³Ù„Ø§Ù…Øª Ù†Ø§Ù…ÙˆÙÙ‚ ÙˆÙ„ÛŒ Ù…Ù…Ú©Ù†Ù‡ Ø¯ÛŒÙ¾Ù„ÙˆÛŒ Ù…ÙˆÙÙ‚ Ø¨Ø§Ø´Ù‡" -ForegroundColor Red
