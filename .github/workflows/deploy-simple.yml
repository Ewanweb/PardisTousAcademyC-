name: Simple Deploy API to Server

on:
  workflow_dispatch: # Manual trigger only

jobs:
  deploy:
    runs-on: windows-latest

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup .NET
        uses: actions/setup-dotnet@v4
        with:
          dotnet-version: "9.0.x"

      # Build Backend Only
      - name: Build API
        run: |
          dotnet publish Endpoints/Api/Api.csproj -c Release -o ./publish/api

      # Create deployment folder
      - name: Prepare deployment
        run: |
          # Create folders
          mkdir deployment

          # Copy API files to root
          xcopy /E /I /Y "publish\api\*" "deployment\"

          # Create simple appsettings.json
          echo '{
            "ConnectionStrings": {
              "DefaultConnection": "Server=localhost\\\\SQLEXPRESS;Database=pardisto_api;User Id=ewan;Password=0gH!_kE2buHfcb0w;TrustServerCertificate=True;Encrypt=False;"
            },
            "JwtSettings": {
              "Key": "n8B5C1yK4mYx7DqRZQ0pVJm0r2KzF+T9aA1XcH3sWlU=",
              "Issuer": "PardisAcademy",
              "Audience": "PardisAcademyUsers"
            },
            "AllowedHosts": "*"
          }' > deployment\appsettings.json

          # Create web.config for API
          echo '<?xml version="1.0" encoding="utf-8"?>
          <configuration>
            <system.webServer>
              <handlers>
                <add name="aspNetCore" path="*" verb="*" modules="AspNetCoreModuleV2" resourceType="Unspecified" />
              </handlers>
              <aspNetCore processPath="dotnet" arguments=".\Api.dll" stdoutLogEnabled="true" stdoutLogFile=".\logs\stdout" hostingModel="inprocess">
                <environmentVariables>
                  <environmentVariable name="ASPNETCORE_ENVIRONMENT" value="Production" />
                </environmentVariables>
              </aspNetCore>
            </system.webServer>
          </configuration>' > deployment\web.config

      # Deploy directly without app_offline.htm
      - name: Deploy to Server
        uses: SamKirkland/FTP-Deploy-Action@v4.3.4
        with:
          server: ftp.api.pardistous.ir
          username: ewan
          password: mahan1384@
          local-dir: ./deployment/
          server-dir: /
          timeout: 120000

      # Simple health check
      - name: Check if deployed
        run: |
          Write-Host "Waiting for application to start..."
          Start-Sleep -Seconds 60

          $maxAttempts = 3
          $attempt = 1

          while ($attempt -le $maxAttempts) {
            try {
              Write-Host "Health check attempt $attempt of $maxAttempts"
              $response = Invoke-WebRequest -Uri "https://api.pardistous.ir/api/health" -UseBasicParsing -TimeoutSec 15
              if ($response.StatusCode -eq 200) {
                Write-Host "✅ API is working! Deployment successful!"
                exit 0
              }
            } catch {
              Write-Host "⚠️ Attempt $attempt failed: $($_.Exception.Message)"
            }
            
            if ($attempt -lt $maxAttempts) {
              Write-Host "Waiting 30 seconds before next attempt..."
              Start-Sleep -Seconds 30
            }
            $attempt++
          }

          Write-Host "❌ API health check failed after $maxAttempts attempts"
          Write-Host "The deployment may still be successful, but the API is not responding yet"
