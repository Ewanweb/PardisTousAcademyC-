name: Safe Deploy - Stop, Build, Deploy, Test (No deletes on stop)

on:
  push:
    branches: [master]

jobs:
  deploy:
    runs-on: windows-latest

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup .NET
        uses: actions/setup-dotnet@v4
        with:
          dotnet-version: "9.0.x"

      # 0) Ø³Ø§Ø®Øª ÙØ§ÛŒÙ„ app_offline.htm
      - name: ğŸ§± Create app_offline.htm
        shell: pwsh
        run: |
          New-Item -ItemType Directory -Path maintenance -Force | Out-Null
          @"
          <html>
            <head><meta charset="utf-8" /></head>
            <body style="font-family:tahoma;padding:40px">
              <h2>Ø³Ø§ÛŒØª Ø¯Ø± Ø­Ø§Ù„ Ø¨Ø±ÙˆØ²Ø±Ø³Ø§Ù†ÛŒ Ø§Ø³Øªâ€¦</h2>
              <p>Ù„Ø·ÙØ§Ù‹ Ú†Ù†Ø¯ Ù„Ø­Ø¸Ù‡ Ø¨Ø¹Ø¯ Ø¯ÙˆØ¨Ø§Ø±Ù‡ ØªÙ„Ø§Ø´ Ú©Ù†ÛŒØ¯.</p>
            </body>
          </html>
          "@ | Out-File "maintenance/app_offline.htm" -Encoding UTF8

      # 1) Ù†ØµØ¨ WinSCP (Ø§Ø¨Ø²Ø§Ø± FTP/FTPS Ù‚Ø§Ø¨Ù„ Ø§Ø¹ØªÙ…Ø§Ø¯ Ø¨Ø±Ø§ÛŒ put/rm Ø¨Ø¯ÙˆÙ† sync)
      - name: ğŸ”§ Install WinSCP
        shell: pwsh
        run: |
          choco install winscp -y
          & "C:\Program Files (x86)\WinSCP\WinSCP.com" /help | Out-Null

      # 2) STOP: ÙÙ‚Ø· Ø¢Ù¾Ù„ÙˆØ¯ app_offline.htm (Ù‡ÛŒÚ† Ø­Ø°Ù/Ø³ÛŒÙ†Ú©ÛŒ Ø§Ù†Ø¬Ø§Ù… Ù†Ù…ÛŒâ€ŒØ´ÙˆØ¯)
      - name: ğŸ›‘ Stop App (upload app_offline.htm) - NO DELETE
        shell: pwsh
        run: |
          $localFile = Resolve-Path "maintenance/app_offline.htm"

          $script = @"
          option batch abort
          option confirm off

          open ftp://ewan:mahan1384@@ftp.api.pardistous.ir/

          put "$localFile" "/app_offline.htm"

          exit
          "@

          $script | Out-File "winscp_stop.txt" -Encoding ASCII

          & "C:\Program Files (x86)\WinSCP\WinSCP.com" `
            /ini=nul `
            /log=winscp_stop.log `
            /script=winscp_stop.txt

          if ($LASTEXITCODE -ne 0) {
            Get-Content winscp_stop.log
            throw "WinSCP stop failed"
          }


      - name: â³ Wait for IIS unload
        shell: pwsh
        run: Start-Sleep -Seconds 10

      # 3) BUILD
      - name: ğŸ”¨ Build API
        shell: pwsh
        run: |
          dotnet publish Endpoints/Api/Api.csproj -c Release -o ./publish/api

      # 4) Ø¢Ù…Ø§Ø¯Ù‡â€ŒØ³Ø§Ø²ÛŒ ÙØ§ÛŒÙ„â€ŒÙ‡Ø§ÛŒ Deploy
      - name: ğŸ“¦ Prepare deployment
        shell: pwsh
        run: |
          if (Test-Path deployment) { Remove-Item deployment -Recurse -Force }
          New-Item -ItemType Directory -Path deployment | Out-Null
          Copy-Item publish/api/* deployment/ -Recurse -Force
          New-Item -ItemType Directory -Path deployment/logs -Force | Out-Null

      # 5) DEPLOY (Ù‡Ù…ÙˆÙ† Ø§Ú©Ø´Ù† Ù‚Ø¨Ù„ÛŒ)
      - name: ğŸš€ Deploy API
        uses: SamKirkland/FTP-Deploy-Action@v4.3.4
        with:
          server: ftp.api.pardistous.ir
          username: ewan
          password: mahan1384@
          local-dir: ./deployment/
          server-dir: /
          dangerous-clean-slate: false
          timeout: 180000

          $script = @"
          option batch abort
          option confirm off

          open ftp://ewan:mahan1384@@ftp.api.pardistous.ir/

          rm "/app_offline.htm"

          exit
          "@

          $script | Out-File "winscp_start.txt" -Encoding ASCII

          & "C:\Program Files (x86)\WinSCP\WinSCP.com" `
            /ini=nul `
            /log=winscp_start.log `
            /script=winscp_start.txt

          if ($LASTEXITCODE -ne 0) {
            Get-Content winscp_start.log
            throw "WinSCP start failed"
          }

      - name: â³ Wait for startup
        shell: pwsh
        run: Start-Sleep -Seconds 40

      # 7) Health Check
      - name: ğŸ¥ Health Check
        shell: pwsh
        run: |
          $ok = $false
          for ($i = 1; $i -le 6; $i++) {
            try {
              $res = Invoke-WebRequest https://api.pardistous.ir/api/health -TimeoutSec 15
              if ($res.StatusCode -eq 200) { $ok = $true; break }
            } catch {}
            Start-Sleep -Seconds 15
          }
          if (-not $ok) { throw "Health check failed" }

      - name: ğŸ“Š Final Report
        shell: pwsh
        run: |
          Write-Host "ğŸ‰ Deploy completed successfully!"
          Write-Host "API: https://api.pardistous.ir"
          Write-Host "Swagger: https://api.pardistous.ir/swagger"
