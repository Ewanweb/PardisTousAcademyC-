name: Safe Deploy - Stop, Build, Deploy, Test

on:
  push:
    branches: [master]

jobs:
  deploy:
    runs-on: windows-latest

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup .NET
        uses: actions/setup-dotnet@v4
        with:
          dotnet-version: "9.0.x"

      # 1ï¸âƒ£ Ø³Ø§Ø®Øª app_offline.htm
      - name: ğŸ§± Create app_offline.htm
        shell: pwsh
        run: |
          New-Item -ItemType Directory -Path maintenance -Force | Out-Null
          @"
          <html>
            <head><meta charset="utf-8" /></head>
            <body style="font-family:tahoma;padding:40px">
              <h2>Ø³Ø§ÛŒØª Ø¯Ø± Ø­Ø§Ù„ Ø¨Ø±ÙˆØ²Ø±Ø³Ø§Ù†ÛŒ Ø§Ø³Øªâ€¦</h2>
              <p>Ù„Ø·ÙØ§Ù‹ Ú†Ù†Ø¯ Ù„Ø­Ø¸Ù‡ Ø¨Ø¹Ø¯ Ø¯ÙˆØ¨Ø§Ø±Ù‡ ØªÙ„Ø§Ø´ Ú©Ù†ÛŒØ¯.</p>
            </body>
          </html>
          "@ | Out-File "maintenance/app_offline.htm" -Encoding UTF8

      # 2ï¸âƒ£ Stop Ø¨Ø±Ù†Ø§Ù…Ù‡ (IIS)
      - name: ğŸ›‘ Stop App (upload app_offline.htm)
        uses: SamKirkland/FTP-Deploy-Action@v4.3.4
        with:
          server: ftp.api.pardistous.ir
          username: ewan
          password: mahan1384@
          local-dir: ./maintenance/
          server-dir: /
          dangerous-clean-slate: false
          timeout: 180000

      # 3ï¸âƒ£ ØµØ¨Ø± Ú©ÙˆØªØ§Ù‡ Ø¨Ø±Ø§ÛŒ Ø¢Ø²Ø§Ø¯ Ø´Ø¯Ù† ÙØ§ÛŒÙ„â€ŒÙ‡Ø§
      - name: â³ Wait for IIS unload
        shell: pwsh
        run: Start-Sleep -Seconds 10

      # 4ï¸âƒ£ Build
      - name: ğŸ”¨ Build API
        shell: pwsh
        run: |
          dotnet publish Endpoints/Api/Api.csproj -c Release -o ./publish/api

      # 5ï¸âƒ£ Ø¢Ù…Ø§Ø¯Ù‡â€ŒØ³Ø§Ø²ÛŒ ÙØ§ÛŒÙ„â€ŒÙ‡Ø§ÛŒ Deploy
      - name: ğŸ“¦ Prepare deployment
        shell: pwsh
        run: |
          if (Test-Path deployment) { Remove-Item deployment -Recurse -Force }
          New-Item -ItemType Directory -Path deployment | Out-Null
          Copy-Item publish/api/* deployment/ -Recurse -Force
          New-Item -ItemType Directory -Path deployment/logs -Force | Out-Null

      # 6ï¸âƒ£ Deploy ÙØ§ÛŒÙ„â€ŒÙ‡Ø§ÛŒ Ø¬Ø¯ÛŒØ¯
      - name: ğŸš€ Deploy API
        uses: SamKirkland/FTP-Deploy-Action@v4.3.4
        with:
          server: ftp.api.pardistous.ir
          username: ewan
          password: mahan1384@
          local-dir: ./deployment/
          server-dir: /
          dangerous-clean-slate: false
          timeout: 180000

      # 7ï¸âƒ£ Start Ø¨Ø±Ù†Ø§Ù…Ù‡ (Ø­Ø°Ù app_offline.htm Ø¨Ø§ Ù‡Ù…Ø§Ù† Ù¾Ú©ÛŒØ¬)
      - name: â–¶ï¸ Start App (remove app_offline.htm)
        uses: SamKirkland/FTP-Deploy-Action@v4.3.4
        with:
          server: ftp.api.pardistous.ir
          username: ewan
          password: mahan1384@
          local-dir: ./empty/
          server-dir: /
          dangerous-clean-slate: true
          exclude: |
            **/*
            !app_offline.htm
          timeout: 180000

      # 8ï¸âƒ£ ØµØ¨Ø± Ø¨Ø±Ø§ÛŒ Ø¨Ø§Ù„Ø§ Ø¢Ù…Ø¯Ù† Ø§Ù¾
      - name: â³ Wait for startup
        shell: pwsh
        run: Start-Sleep -Seconds 40

      # 9ï¸âƒ£ Health Check
      - name: ğŸ¥ Health Check
        shell: pwsh
        run: |
          $ok = $false
          for ($i = 1; $i -le 6; $i++) {
            try {
              $res = Invoke-WebRequest https://api.pardistous.ir/api/health -TimeoutSec 15
              if ($res.StatusCode -eq 200) {
                Write-Host "âœ… API is healthy"
                $ok = $true
                break
              }
            } catch {
              Write-Host "â³ API not ready yet..."
            }
            Start-Sleep -Seconds 15
          }
          if (-not $ok) { exit 1 }

      # ğŸ”Ÿ Ú¯Ø²Ø§Ø±Ø´ Ù†Ù‡Ø§ÛŒÛŒ
      - name: ğŸ“Š Final Report
        shell: pwsh
        run: |
          Write-Host "ğŸ‰ Deploy completed successfully!"
          Write-Host "API: https://api.pardistous.ir"
          Write-Host "Swagger: https://api.pardistous.ir/swagger"
