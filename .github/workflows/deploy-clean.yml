name: Clean Deploy - Ù¾Ø§Ú© Ú©Ø±Ø¯Ù† Ú©Ø§Ù…Ù„ Ø³Ø±ÙˆØ± Ùˆ Ø¯ÛŒÙ¾Ù„ÙˆÛŒ Ø¬Ø¯ÛŒØ¯

on:
    push:
      branches: [master]

jobs:
  clean-deploy:
    runs-on: windows-latest

    steps:
      - name: Ø¨Ø±Ø±Ø³ÛŒ ØªØ£ÛŒÛŒØ¯ Ù¾Ø§Ú©â€ŒØ³Ø§Ø²ÛŒ
        if: github.event.inputs.confirm_clean != 'YES'
        run: |
          Write-Host "âŒ Ø¨Ø±Ø§ÛŒ Ù¾Ø§Ú© Ú©Ø±Ø¯Ù† Ú©Ø§Ù…Ù„ Ø³Ø±ÙˆØ± Ø¨Ø§ÛŒØ¯ 'YES' ÙˆØ§Ø±Ø¯ Ú©Ù†ÛŒ" -ForegroundColor Red
          exit 1

      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup .NET
        uses: actions/setup-dotnet@v4
        with:
          dotnet-version: "9.0.x"

      # Ù…Ø±Ø­Ù„Ù‡ 1: Ù¾Ø§Ú© Ú©Ø±Ø¯Ù† Ú©Ø§Ù…Ù„ Ø³Ø±ÙˆØ±
      - name: ğŸ—‘ï¸ Ù¾Ø§Ú© Ú©Ø±Ø¯Ù† Ú©Ø§Ù…Ù„ ÙØ§ÛŒÙ„â€ŒÙ‡Ø§ÛŒ Ø³Ø±ÙˆØ±
        run: |
          Write-Host "ğŸš¨ Ø´Ø±ÙˆØ¹ Ù¾Ø§Ú©â€ŒØ³Ø§Ø²ÛŒ Ú©Ø§Ù…Ù„ Ø³Ø±ÙˆØ±..." -ForegroundColor Red

          # Ø§ÛŒØ¬Ø§Ø¯ Ø§Ø³Ú©Ø±ÛŒÙ¾Øª FTP Ø¨Ø±Ø§ÛŒ Ù¾Ø§Ú©â€ŒØ³Ø§Ø²ÛŒ
          @"
          open ftp.api.pardistous.ir
          ewan
          mahan1384@
          binary

          # Ø­Ø°Ù ÙØ§ÛŒÙ„â€ŒÙ‡Ø§ÛŒ Ø§ØµÙ„ÛŒ
          delete Api.dll
          delete Api.exe
          delete Api.pdb
          delete Api.deps.json
          delete Api.runtimeconfig.json
          delete appsettings.json
          delete appsettings.Development.json
          delete appsettings.Production.json
          delete web.config
          delete app_offline.htm

          # Ø­Ø°Ù ÙØ§ÛŒÙ„â€ŒÙ‡Ø§ÛŒ .NET
          delete Microsoft.AspNetCore.dll
          delete Microsoft.Extensions.dll
          delete System.Text.Json.dll
          delete Newtonsoft.Json.dll
          delete AutoMapper.dll
          delete MediatR.dll

          # Ø­Ø°Ù ÙØ§ÛŒÙ„â€ŒÙ‡Ø§ÛŒ Ù¾Ø±ÙˆÚ˜Ù‡
          delete Pardis.Application.dll
          delete Pardis.Domain.dll
          delete Pardis.Infrastructure.dll
          delete Pardis.Query.dll
          delete Pardis.Facade.dll

          # Ø­Ø°Ù Ù¾ÙˆØ´Ù‡â€ŒÙ‡Ø§ (Ø§Ú¯Ø± Ø®Ø§Ù„ÛŒ Ø¨Ø§Ø´Ù†Ø¯)
          rmdir wwwroot
          rmdir logs
          rmdir Uploads
          rmdir refs
          rmdir runtimes

          quit
          "@ | Out-File -FilePath "ftp_clean.txt" -Encoding ASCII

          Write-Host "Ø§Ø¬Ø±Ø§ÛŒ Ø¯Ø³ØªÙˆØ±Ø§Øª Ù¾Ø§Ú©â€ŒØ³Ø§Ø²ÛŒ..." -ForegroundColor Yellow
          ftp -s:ftp_clean.txt

          Remove-Item ftp_clean.txt -ErrorAction SilentlyContinue
          Write-Host "âœ… Ù¾Ø§Ú©â€ŒØ³Ø§Ø²ÛŒ Ø§ÙˆÙ„ÛŒÙ‡ Ø§Ù†Ø¬Ø§Ù… Ø´Ø¯" -ForegroundColor Green

      # Ù…Ø±Ø­Ù„Ù‡ 2: Ù¾Ø§Ú©â€ŒØ³Ø§Ø²ÛŒ Ø¹Ù…ÛŒÙ‚â€ŒØªØ±
      - name: ğŸ§¹ Ù¾Ø§Ú©â€ŒØ³Ø§Ø²ÛŒ Ø¹Ù…ÛŒÙ‚ ÙØ§ÛŒÙ„â€ŒÙ‡Ø§ÛŒ Ø¨Ø§Ù‚ÛŒâ€ŒÙ…Ø§Ù†Ø¯Ù‡
        run: |
          Write-Host "ğŸ§¹ Ù¾Ø§Ú©â€ŒØ³Ø§Ø²ÛŒ Ø¹Ù…ÛŒÙ‚..." -ForegroundColor Yellow

          @"
          open ftp.api.pardistous.ir
          ewan
          mahan1384@

          # Ø­Ø°Ù ÙØ§ÛŒÙ„â€ŒÙ‡Ø§ÛŒ Ø§Ø­ØªÙ…Ø§Ù„ÛŒ Ø¯ÛŒÚ¯Ø±
          delete *.dll
          delete *.exe
          delete *.pdb
          delete *.json
          delete *.config
          delete *.xml
          delete *.htm
          delete *.html

          quit
          "@ | Out-File -FilePath "ftp_deep_clean.txt" -Encoding ASCII

          ftp -s:ftp_deep_clean.txt
          Remove-Item ftp_deep_clean.txt -ErrorAction SilentlyContinue

          Write-Host "âœ… Ù¾Ø§Ú©â€ŒØ³Ø§Ø²ÛŒ Ø¹Ù…ÛŒÙ‚ ØªÚ©Ù…ÛŒÙ„ Ø´Ø¯" -ForegroundColor Green

      # Ù…Ø±Ø­Ù„Ù‡ 3: ØµØ¨Ø± Ø¨Ø±Ø§ÛŒ ØªÚ©Ù…ÛŒÙ„ Ù¾Ø§Ú©â€ŒØ³Ø§Ø²ÛŒ
      - name: â³ ØµØ¨Ø± Ø¨Ø±Ø§ÛŒ ØªÚ©Ù…ÛŒÙ„ Ù¾Ø§Ú©â€ŒØ³Ø§Ø²ÛŒ
        run: |
          Write-Host "â³ ØµØ¨Ø± 30 Ø«Ø§Ù†ÛŒÙ‡ Ø¨Ø±Ø§ÛŒ ØªÚ©Ù…ÛŒÙ„ Ù¾Ø§Ú©â€ŒØ³Ø§Ø²ÛŒ..." -ForegroundColor Cyan
          Start-Sleep -Seconds 30

      # Ù…Ø±Ø­Ù„Ù‡ 4: Build Ú©Ø±Ø¯Ù† Ù¾Ø±ÙˆÚ˜Ù‡
      - name: ğŸ”¨ Build Ú©Ø±Ø¯Ù† API
        run: |
          Write-Host "ğŸ”¨ Ø´Ø±ÙˆØ¹ Build..." -ForegroundColor Cyan
          dotnet publish Endpoints/Api/Api.csproj -c Release -o ./publish/api
          Write-Host "âœ… Build ØªÚ©Ù…ÛŒÙ„ Ø´Ø¯" -ForegroundColor Green

      # Ù…Ø±Ø­Ù„Ù‡ 5: Ø¢Ù…Ø§Ø¯Ù‡â€ŒØ³Ø§Ø²ÛŒ ÙØ§ÛŒÙ„â€ŒÙ‡Ø§ÛŒ deployment
      - name: ğŸ“¦ Ø¢Ù…Ø§Ø¯Ù‡â€ŒØ³Ø§Ø²ÛŒ ÙØ§ÛŒÙ„â€ŒÙ‡Ø§ÛŒ deployment
        run: |
          Write-Host "ğŸ“¦ Ø¢Ù…Ø§Ø¯Ù‡â€ŒØ³Ø§Ø²ÛŒ ÙØ§ÛŒÙ„â€ŒÙ‡Ø§..." -ForegroundColor Cyan

          # Ø§ÛŒØ¬Ø§Ø¯ Ù¾ÙˆØ´Ù‡ deployment
          mkdir deployment

          # Ú©Ù¾ÛŒ Ú©Ø±Ø¯Ù† ÙØ§ÛŒÙ„â€ŒÙ‡Ø§ÛŒ API
          xcopy /E /I /Y "publish\api\*" "deployment\"

          # Ø§ÛŒØ¬Ø§Ø¯ appsettings.json
          @"
          {
            "ConnectionStrings": {
              "DefaultConnection": "Server=localhost\\\\SQLEXPRESS;Database=pardisto_api;User Id=ewan;Password=0gH!_kE2buHfcb0w;TrustServerCertificate=True;Encrypt=False;"
            },
            "JwtSettings": {
              "Key": "n8B5C1yK4mYx7DqRZQ0pVJm0r2KzF+T9aA1XcH3sWlU=",
              "Issuer": "PardisAcademy",
              "Audience": "PardisAcademyUsers"
            },
            "AllowedHosts": "*",
            "Logging": {
              "LogLevel": {
                "Default": "Information",
                "Microsoft.AspNetCore": "Warning"
              }
            }
          }
          "@ | Out-File -FilePath "deployment\appsettings.json" -Encoding UTF8

          # Ø§ÛŒØ¬Ø§Ø¯ web.config
          @"
          <?xml version="1.0" encoding="utf-8"?>
          <configuration>
            <system.webServer>
              <handlers>
                <add name="aspNetCore" path="*" verb="*" modules="AspNetCoreModuleV2" resourceType="Unspecified" />
              </handlers>
              <aspNetCore processPath="dotnet" arguments=".\Api.dll" stdoutLogEnabled="true" stdoutLogFile=".\logs\stdout" hostingModel="inprocess">
                <environmentVariables>
                  <environmentVariable name="ASPNETCORE_ENVIRONMENT" value="Production" />
                </environmentVariables>
              </aspNetCore>
              <defaultDocument>
                <files>
                  <clear />
                </files>
              </defaultDocument>
            </system.webServer>
          </configuration>
          "@ | Out-File -FilePath "deployment\web.config" -Encoding UTF8

          Write-Host "âœ… ÙØ§ÛŒÙ„â€ŒÙ‡Ø§ Ø¢Ù…Ø§Ø¯Ù‡ Ø´Ø¯Ù†Ø¯" -ForegroundColor Green

      # Ù…Ø±Ø­Ù„Ù‡ 6: Upload Ú©Ø±Ø¯Ù† ÙØ§ÛŒÙ„â€ŒÙ‡Ø§ÛŒ Ø¬Ø¯ÛŒØ¯
      - name: ğŸš€ Upload ÙØ§ÛŒÙ„â€ŒÙ‡Ø§ÛŒ Ø¬Ø¯ÛŒØ¯ Ø¨Ù‡ Ø³Ø±ÙˆØ±
        uses: SamKirkland/FTP-Deploy-Action@v4.3.4
        with:
          server: ftp.api.pardistous.ir
          username: ewan
          password: mahan1384@
          local-dir: ./deployment/
          server-dir: /
          timeout: 180000
          # Ø¢Ù¾Ù„ÙˆØ¯ ØªÙ…Ø§Ù… ÙØ§ÛŒÙ„â€ŒÙ‡Ø§ Ø¨Ø¯ÙˆÙ† Ú†Ú© Ú©Ø±Ø¯Ù† ØªØºÛŒÛŒØ±Ø§Øª
          dangerous-clean-slate: true

      # Ù…Ø±Ø­Ù„Ù‡ 7: ØµØ¨Ø± Ø¨Ø±Ø§ÛŒ Ø±Ø§Ù‡â€ŒØ§Ù†Ø¯Ø§Ø²ÛŒ
      - name: â³ ØµØ¨Ø± Ø¨Ø±Ø§ÛŒ Ø±Ø§Ù‡â€ŒØ§Ù†Ø¯Ø§Ø²ÛŒ Ø³Ø±ÙˆØ±
        run: |
          Write-Host "â³ ØµØ¨Ø± Ø¨Ø±Ø§ÛŒ Ø±Ø§Ù‡â€ŒØ§Ù†Ø¯Ø§Ø²ÛŒ Ø³Ø±ÙˆØ±..." -ForegroundColor Cyan
          Start-Sleep -Seconds 60

      # Ù…Ø±Ø­Ù„Ù‡ 8: ØªØ³Øª Ø³Ù„Ø§Ù…Øª API
      - name: ğŸ¥ ØªØ³Øª Ø³Ù„Ø§Ù…Øª API
        run: |
          Write-Host "ğŸ¥ ØªØ³Øª Ø³Ù„Ø§Ù…Øª API..." -ForegroundColor Cyan

          $maxAttempts = 5
          $attempt = 1
          $success = $false

          while ($attempt -le $maxAttempts -and -not $success) {
            try {
              Write-Host "ğŸ” ØªÙ„Ø§Ø´ $attempt Ø§Ø² $maxAttempts" -ForegroundColor Yellow
              
              $response = Invoke-WebRequest -Uri "https://api.pardistous.ir/api/health" -UseBasicParsing -TimeoutSec 20
              
              if ($response.StatusCode -eq 200) {
                Write-Host "âœ… API Ú©Ø§Ø± Ù…ÛŒâ€ŒÚ©Ù†Ù‡! Ø¯ÛŒÙ¾Ù„ÙˆÛŒ Ù…ÙˆÙÙ‚ Ø¨ÙˆØ¯!" -ForegroundColor Green
                Write-Host "ğŸŒ Ø¢Ø¯Ø±Ø³ API: https://api.pardistous.ir" -ForegroundColor Cyan
                Write-Host "ğŸ“š Ù…Ø³ØªÙ†Ø¯Ø§Øª Swagger: https://api.pardistous.ir/swagger" -ForegroundColor Cyan
                $success = $true
              }
            } catch {
              Write-Host "âš ï¸ ØªÙ„Ø§Ø´ $attempt Ù†Ø§Ù…ÙˆÙÙ‚: $($_.Exception.Message)" -ForegroundColor Red
            }
            
            if ($attempt -lt $maxAttempts -and -not $success) {
              Write-Host "â³ ØµØ¨Ø± 45 Ø«Ø§Ù†ÛŒÙ‡ Ù‚Ø¨Ù„ Ø§Ø² ØªÙ„Ø§Ø´ Ø¨Ø¹Ø¯ÛŒ..." -ForegroundColor Yellow
              Start-Sleep -Seconds 45
            }
            $attempt++
          }

          if (-not $success) {
            Write-Host "âŒ ØªØ³Øª Ø³Ù„Ø§Ù…Øª Ù†Ø§Ù…ÙˆÙÙ‚ Ø¨ÙˆØ¯ ÙˆÙ„ÛŒ Ù…Ù…Ú©Ù†Ù‡ Ø¯ÛŒÙ¾Ù„ÙˆÛŒ Ù…ÙˆÙÙ‚ Ø¨Ø§Ø´Ù‡" -ForegroundColor Red
            Write-Host "ğŸ”§ Ú†Ù†Ø¯ Ø¯Ù‚ÛŒÙ‚Ù‡ ØµØ¨Ø± Ú©Ù† Ùˆ Ø¯ÙˆØ¨Ø§Ø±Ù‡ ØªØ³Øª Ú©Ù†" -ForegroundColor Yellow
          }

      # Ù…Ø±Ø­Ù„Ù‡ 9: Ú¯Ø²Ø§Ø±Ø´ Ù†Ù‡Ø§ÛŒÛŒ
      - name: ğŸ“Š Ú¯Ø²Ø§Ø±Ø´ Ù†Ù‡Ø§ÛŒÛŒ
        run: |
          Write-Host ""
          Write-Host "ğŸ‰ Ø¯ÛŒÙ¾Ù„ÙˆÛŒ Ú©Ø§Ù…Ù„ ØªÚ©Ù…ÛŒÙ„ Ø´Ø¯!" -ForegroundColor Green
          Write-Host "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”" -ForegroundColor Cyan
          Write-Host "âœ… Ø³Ø±ÙˆØ± Ú©Ø§Ù…Ù„Ø§Ù‹ Ù¾Ø§Ú© Ø´Ø¯" -ForegroundColor Green
          Write-Host "âœ… ÙØ§ÛŒÙ„â€ŒÙ‡Ø§ÛŒ Ø¬Ø¯ÛŒØ¯ Ø¢Ù¾Ù„ÙˆØ¯ Ø´Ø¯Ù†Ø¯" -ForegroundColor Green
          Write-Host "âœ… ØªÙ†Ø¸ÛŒÙ…Ø§Øª Production Ø§Ø¹Ù…Ø§Ù„ Ø´Ø¯" -ForegroundColor Green
          Write-Host ""
          Write-Host "ğŸŒ Ù„ÛŒÙ†Ú©â€ŒÙ‡Ø§ÛŒ Ù…Ù‡Ù…:" -ForegroundColor Cyan
          Write-Host "   â€¢ API: https://api.pardistous.ir" -ForegroundColor White
          Write-Host "   â€¢ Health Check: https://api.pardistous.ir/api/health" -ForegroundColor White
          Write-Host "   â€¢ Swagger: https://api.pardistous.ir/swagger" -ForegroundColor White
          Write-Host ""
          Write-Host "ğŸ”§ Ø§Ú¯Ø± Ù…Ø´Ú©Ù„ÛŒ Ø¯Ø§Ø´ØªÛŒØŒ Ú†Ù†Ø¯ Ø¯Ù‚ÛŒÙ‚Ù‡ ØµØ¨Ø± Ú©Ù† ØªØ§ Ø³Ø±ÙˆØ± Ú©Ø§Ù…Ù„Ø§Ù‹ Ø±Ø§Ù‡â€ŒØ§Ù†Ø¯Ø§Ø²ÛŒ Ø¨Ø´Ù‡" -ForegroundColor Yellow
          Write-Host "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”" -ForegroundColor Cyan
