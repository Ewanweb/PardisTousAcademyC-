name: Clean Deploy - Ù¾Ø§Ú© Ú©Ø±Ø¯Ù† Ú©Ø§Ù…Ù„ Ø³Ø±ÙˆØ± Ùˆ Ø¯ÛŒÙ¾Ù„ÙˆÛŒ Ø¬Ø¯ÛŒØ¯

on:
  push:
    branches: [master]

jobs:
  clean-deploy:
    runs-on: windows-latest

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup .NET
        uses: actions/setup-dotnet@v4
        with:
          dotnet-version: "9.0.x"

      # Ù…Ø±Ø­Ù„Ù‡ 0: Ù…ØªÙˆÙ‚Ù Ú©Ø±Ø¯Ù† Ø§Ù¾Ù„ÛŒÚ©ÛŒØ´Ù† (IIS) Ø¨Ø§ app_offline.htm
      # Ø§ÛŒÙ† Ú©Ø§Ø± Ø¬Ù„ÙˆÛŒ Ù‚ÙÙ„ Ø´Ø¯Ù† dll Ù‡Ø§ Ø±Ùˆ Ù…ÛŒâ€ŒÚ¯ÛŒØ±Ù‡ Ùˆ Deploy Ø±Ùˆ Ù¾Ø§ÛŒØ¯Ø§Ø± Ù…ÛŒâ€ŒÚ©Ù†Ù‡.
      - name: ğŸ›‘ Stop App (app_offline.htm)
        shell: pwsh
        run: |
          Write-Host "ğŸ›‘ Putting app_offline.htm to stop the app..." -ForegroundColor Yellow

          # ÙØ§ÛŒÙ„ maintenance
          @"
          <html>
            <head><meta charset="utf-8" /></head>
            <body style="font-family:tahoma;padding:40px">
              <h2>Ø³Ø§ÛŒØª Ø¯Ø± Ø­Ø§Ù„ Ø¨Ø±ÙˆØ²Ø±Ø³Ø§Ù†ÛŒ Ø§Ø³Øª...</h2>
            </body>
          </html>
          "@ | Out-File -FilePath "app_offline.htm" -Encoding UTF8

          # Ø§Ø³Ú©Ø±ÛŒÙ¾Øª FTP Ø³Ø§Ø²Ú¯Ø§Ø± Ø¨Ø§ Plesk
          @"
          open ftp.api.pardistous.ir
          user ewan
          mahan1384@
          binary
          put app_offline.htm
          quit
          "@ | Out-File -FilePath "ftp_stop.txt" -Encoding ASCII

          ftp -s:ftp_stop.txt

          Remove-Item ftp_stop.txt -ErrorAction SilentlyContinue
          Remove-Item app_offline.htm -ErrorAction SilentlyContinue

          Write-Host "âš ï¸ Ø§Ú¯Ø± Ù„Ø§Ú¯ÛŒÙ† Ù…ÙˆÙÙ‚ Ø¨ÙˆØ¯Ù‡ Ø¨Ø§Ø´Ø¯ØŒ app_offline.htm Ø¢Ù¾Ù„ÙˆØ¯ Ø´Ø¯Ù‡ Ø§Ø³Øª." -ForegroundColor Yellow

          Write-Host "ğŸ›‘ Putting app_offline.htm to stop the app..." -ForegroundColor Yellow

          # ÙØ§ÛŒÙ„ maintenance
          @"
          <html>
            <head><meta charset="utf-8" /></head>
            <body style="font-family:tahoma;padding:40px">
              <h2>Ø³Ø§ÛŒØª Ø¯Ø± Ø­Ø§Ù„ Ø¨Ø±ÙˆØ²Ø±Ø³Ø§Ù†ÛŒ Ø§Ø³Øª...</h2>
            </body>
          </html>
          "@ | Out-File -FilePath "app_offline.htm" -Encoding UTF8

          # Ø§Ø³Ú©Ø±ÛŒÙ¾Øª FTP ØµØ­ÛŒØ­
          @"
          open ftp.api.pardistous.ir
          user ewan mahan1384@
          binary
          put app_offline.htm
          quit
          "@ | Out-File -FilePath "ftp_stop.txt" -Encoding ASCII

          ftp -s:ftp_stop.txt

          Remove-Item ftp_stop.txt -ErrorAction SilentlyContinue
          Remove-Item app_offline.htm -ErrorAction SilentlyContinue

          Write-Host "âœ… app_offline.htm uploaded successfully." -ForegroundColor Green


      # Ù…Ø±Ø­Ù„Ù‡ 1: ÛŒÚ© Ù…Ú©Ø« Ú©ÙˆØªØ§Ù‡ Ø¨Ø±Ø§ÛŒ Ø§ÛŒÙ†Ú©Ù‡ IIS ÙˆØ§Ù‚Ø¹Ø§Ù‹ Ø§Ù¾ Ø±Ùˆ unload Ú©Ù†Ù‡
      - name: â³ Wait for IIS to unload
        shell: pwsh
        run: |
          Start-Sleep -Seconds 8

      # Ù…Ø±Ø­Ù„Ù‡ 2: Build/Publish
      - name: ğŸ”¨ Build & Publish API
        shell: pwsh
        run: |
          Write-Host "ğŸ”¨ Publishing..." -ForegroundColor Cyan
          dotnet publish Endpoints/Api/Api.csproj -c Release -o ./publish/api
          Write-Host "âœ… Publish done." -ForegroundColor Green

      # Ù…Ø±Ø­Ù„Ù‡ 3: Ø¢Ù…Ø§Ø¯Ù‡â€ŒØ³Ø§Ø²ÛŒ deployment
      - name: ğŸ“¦ Prepare deployment files
        shell: pwsh
        run: |
          Write-Host "ğŸ“¦ Preparing deployment folder..." -ForegroundColor Cyan

          # Reset deployment folder
          if (Test-Path deployment) { Remove-Item deployment -Recurse -Force }
          New-Item -ItemType Directory -Path deployment | Out-Null

          # Copy published output
          Copy-Item -Path "publish/api/*" -Destination "deployment/" -Recurse -Force

          # Ensure logs directory exists for stdout logs (IMPORTANT)
          New-Item -ItemType Directory -Path "deployment/logs" -Force | Out-Null

          # appsettings.json (Ù‡Ù…ÙˆÙ† Ø³Ø¨Ú© Ø®ÙˆØ¯ØªØŒ Ø¨Ø¯ÙˆÙ† Secrets)
          @"
          {
            "ConnectionStrings": {
              "DefaultConnection": "Server=localhost;Database=pardisto_api;User Id=mahan;Password=ewan1384@;TrustServerCertificate=True;Encrypt=False;Connect Timeout=15;"
            },
            "JwtSettings": {
              "Key": "n8B5C1yK4mYx7DqRZQ0pVJm0r2KzF+T9aA1XcH3sWlU=",
              "Issuer": "PardisAcademy",
              "Audience": "PardisAcademyUsers"
            },
            "AllowedHosts": "*",
            "Logging": {
              "LogLevel": {
                "Default": "Information",
                "Microsoft.AspNetCore": "Warning"
              }
            }
          }
          "@ | Out-File -FilePath "deployment/appsettings.json" -Encoding UTF8

          # web.config (Ø¯Ø±Ø³Øª + stdout ÙØ¹Ø§Ù„)
          @"
          <?xml version="1.0" encoding="utf-8"?>
          <configuration>
            <system.webServer>
              <handlers>
                <add name="aspNetCore" path="*" verb="*" modules="AspNetCoreModuleV2" resourceType="Unspecified" />
              </handlers>

              <aspNetCore processPath="dotnet"
                          arguments=".\Api.dll"
                          hostingModel="inprocess"
                          stdoutLogEnabled="true"
                          stdoutLogFile=".\logs\stdout">
                <environmentVariables>
                  <environmentVariable name="ASPNETCORE_ENVIRONMENT" value="Production" />
                </environmentVariables>
              </aspNetCore>
            </system.webServer>
          </configuration>
          "@ | Out-File -FilePath "deployment/web.config" -Encoding UTF8

          Write-Host "âœ… Deployment files ready." -ForegroundColor Green

      # Ù…Ø±Ø­Ù„Ù‡ 4: Upload + Clean Slate
      # Ø§ÛŒÙ† Ù…Ø±Ø­Ù„Ù‡ Ø®ÙˆØ¯Ø´ Ú©Ù„ Ø±ÙˆØª Ø±Ùˆ Ù¾Ø§Ú© Ù…ÛŒâ€ŒÚ©Ù†Ù‡ Ùˆ ÙØ§ÛŒÙ„â€ŒÙ‡Ø§ÛŒ Ø¬Ø¯ÛŒØ¯ Ø±Ùˆ Ù…ÛŒâ€ŒØ±ÛŒØ²Ù‡.
      # Ø¯Ø± Ù†ØªÛŒØ¬Ù‡ app_offline.htm Ù‡Ù… Ù¾Ø§Ú© Ù…ÛŒâ€ŒØ´Ù‡ Ùˆ Ø§Ù¾ Ø®ÙˆØ¯Ú©Ø§Ø± Ø¯ÙˆØ¨Ø§Ø±Ù‡ Ø¨Ø§Ù„Ø§ Ù…ÛŒØ§Ø¯.
      - name: ğŸš€ Upload (Clean Slate)
        uses: SamKirkland/FTP-Deploy-Action@v4.3.4
        with:
          server: ftp.api.pardistous.ir
          username: ewan
          password: mahan1384@
          local-dir: ./deployment/
          server-dir: /
          timeout: 180000
          dangerous-clean-slate: true

      # Ù…Ø±Ø­Ù„Ù‡ 5: ØµØ¨Ø± Ø¨Ø±Ø§ÛŒ warm up
      - name: â³ Wait for app warm-up
        shell: pwsh
        run: |
          Start-Sleep -Seconds 25

      # Ù…Ø±Ø­Ù„Ù‡ 6: Health Check (Ú†Ù†Ø¯ Ø¨Ø§Ø± ØªÙ„Ø§Ø´)
      - name: ğŸ¥ Health Check
        shell: pwsh
        run: |
          $maxAttempts = 8
          $success = $false

          for ($i = 1; $i -le $maxAttempts; $i++) {
            try {
              Write-Host "ğŸ” Attempt $i/$maxAttempts..." -ForegroundColor Yellow
              $r = Invoke-WebRequest -Uri "https://api.pardistous.ir/api/health" -UseBasicParsing -TimeoutSec 20
              if ($r.StatusCode -eq 200) {
                Write-Host "âœ… API is healthy." -ForegroundColor Green
                $success = $true
                break
              }
            } catch {
              Write-Host "âš ï¸ Not ready: $($_.Exception.Message)" -ForegroundColor Red
            }
            Start-Sleep -Seconds 20
          }

          if (-not $success) {
            Write-Host "âŒ Health check failed." -ForegroundColor Red
            exit 1
          }

      # Ù…Ø±Ø­Ù„Ù‡ 7: Ú¯Ø²Ø§Ø±Ø´ Ù†Ù‡Ø§ÛŒÛŒ
      - name: ğŸ“Š Final report
        shell: pwsh
        run: |
          Write-Host ""
          Write-Host "ğŸ‰ Deploy completed!" -ForegroundColor Green
          Write-Host "ğŸŒ API: https://api.pardistous.ir" -ForegroundColor Cyan
          Write-Host "ğŸ¥ Health: https://api.pardistous.ir/api/health" -ForegroundColor Cyan
          Write-Host "ğŸ“š Swagger: https://api.pardistous.ir/swagger" -ForegroundColor Cyan
