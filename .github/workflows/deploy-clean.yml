name: Safe Deploy - Stop, Build, Deploy, Test (Fast & Safe)

on:
  push:
    branches: [master]

jobs:
  deploy:
    runs-on: windows-latest

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup .NET
        uses: actions/setup-dotnet@v4
        with:
          dotnet-version: "9.0.x"

      - name: üß± Create app_offline.htm
        shell: pwsh
        run: |
          New-Item -ItemType Directory -Path maintenance -Force | Out-Null
          @"
          <html>
            <head><meta charset="utf-8" /></head>
            <body style="font-family:tahoma;padding:40px">
              <h2>ÿ≥ÿß€åÿ™ ÿØÿ± ÿ≠ÿßŸÑ ÿ®ÿ±Ÿàÿ≤ÿ±ÿ≥ÿßŸÜ€å ÿßÿ≥ÿ™‚Ä¶</h2>
              <p>ŸÑÿ∑ŸÅÿßŸã ⁄ÜŸÜÿØ ŸÑÿ≠ÿ∏Ÿá ÿ®ÿπÿØ ÿØŸàÿ®ÿßÿ±Ÿá ÿ™ŸÑÿßÿ¥ ⁄©ŸÜ€åÿØ.</p>
            </body>
          </html>
          "@ | Out-File "maintenance/app_offline.htm" -Encoding UTF8

      - name: üîß Install WinSCP
        shell: pwsh
        run: |
          choco install winscp -y
          & "C:\Program Files (x86)\WinSCP\WinSCP.com" /help | Out-Null

      - name: üõë Stop App (upload app_offline.htm) - NO DELETE
        shell: pwsh
        run: |
          $localFile = Resolve-Path "maintenance/app_offline.htm"

          $script = @"
          option batch abort
          option confirm off
          open ftp://ewan:mahan1384@@ftp.api.pardistous.ir/
          put "$localFile" "/app_offline.htm"
          exit
          "@

          $script | Out-File "winscp_stop.txt" -Encoding ASCII
          & "C:\Program Files (x86)\WinSCP\WinSCP.com" /ini=nul /log=winscp_stop.log /script=winscp_stop.txt

          if ($LASTEXITCODE -ne 0) {
            Get-Content winscp_stop.log
            throw "WinSCP stop failed"
          }

      - name: ‚è≥ Wait for IIS unload
        shell: pwsh
        run: Start-Sleep -Seconds 5

      - name: üî® Build API
        shell: pwsh
        run: |
          dotnet publish Endpoints/Api/Api.csproj -c Release -o ./publish/api

      - name: üì¶ Prepare deployment + web.config
        shell: pwsh
        run: |
          if (Test-Path deployment) { Remove-Item deployment -Recurse -Force }
          New-Item -ItemType Directory -Path deployment | Out-Null
          Copy-Item publish/api/* deployment/ -Recurse -Force
          New-Item -ItemType Directory -Path deployment/logs -Force | Out-Null

          @'
          <?xml version="1.0" encoding="utf-8"?>
          <configuration>
            <location path="." inheritInChildApplications="false">
              <system.webServer>
                <handlers>
                  <add name="aspNetCore" path="*" verb="*" modules="AspNetCoreModuleV2" resourceType="Unspecified" />
                </handlers>

                <aspNetCore processPath="dotnet"
                            arguments=".\Api.dll"
                            stdoutLogEnabled="true"
                            stdoutLogFile=".\logs\stdout"
                            hostingModel="inprocess">
                  <environmentVariables>
                    <environmentVariable name="ASPNETCORE_ENVIRONMENT" value="Production" />
                    <environmentVariable name="ConnectionStrings__DefaultConnection"
                                        value="Server=localhost;Database=pardisto_api;User Id=mahan;Password=ewan1384@;TrustServerCertificate=True;" />
                  </environmentVariables>
                </aspNetCore>

                <httpProtocol>
                  <customHeaders>
                    <add name="X-Content-Type-Options" value="nosniff" />
                    <add name="X-Frame-Options" value="DENY" />
                    <add name="X-XSS-Protection" value="1; mode=block" />
                    <add name="Referrer-Policy" value="strict-origin-when-cross-origin" />
                  </customHeaders>
                </httpProtocol>

                <security>
                  <requestFiltering>
                    <requestLimits maxAllowedContentLength="104857600" />
                  </requestFiltering>
                </security>
              </system.webServer>
            </location>
          </configuration>
          '@ | Out-File -FilePath "deployment/web.config" -Encoding UTF8

      - name: üöÄ Deploy API (no clean-slate)
        uses: SamKirkland/FTP-Deploy-Action@v4.3.4
        with:
          server: ftp.api.pardistous.ir
          username: ewan
          password: mahan1384@
          local-dir: ./deployment/
          server-dir: /
          dangerous-clean-slate: false
          timeout: 180000

      - name: ‚úÖ Resume App (remove app_offline.htm) - NO DELETE
        shell: pwsh
        run: |
          $script = @"
          option batch abort
          option confirm off
          open ftp://ewan:mahan1384@@ftp.api.pardistous.ir/
          rm "/app_offline.htm"
          exit
          "@

          $script | Out-File "winscp_resume.txt" -Encoding ASCII
          & "C:\Program Files (x86)\WinSCP\WinSCP.com" /ini=nul /log=winscp_resume.log /script=winscp_resume.txt

          if ($LASTEXITCODE -ne 0) {
            Get-Content winscp_resume.log
            throw "WinSCP resume failed"
          }

      - name: ‚è≥ Wait for startup
        shell: pwsh
        run: Start-Sleep -Seconds 5

      - name: üìä Final Report
        shell: pwsh
        run: |
          Write-Host "üéâ Deploy completed successfully!"
          Write-Host "API: https://api.pardistous.ir"
          Write-Host "Swagger: https://api.pardistous.ir/swagger"
