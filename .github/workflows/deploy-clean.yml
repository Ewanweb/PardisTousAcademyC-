name: Safe Deploy - Stop, Build, Deploy (app_offline removed in deploy)

on:
  push:
    branches: [master]

jobs:
  deploy:
    runs-on: windows-latest

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup .NET
        uses: actions/setup-dotnet@v4
        with:
          dotnet-version: "9.0.x"

      # 0) Ø³Ø§Ø®Øª ÙØ§ÛŒÙ„ app_offline.htm
      - name: ğŸ§± Create app_offline.htm
        shell: pwsh
        run: |
          New-Item -ItemType Directory -Path maintenance -Force | Out-Null
          @"
          <html>
            <head><meta charset="utf-8" /></head>
            <body style="font-family:tahoma;padding:40px">
              <h2>Ø³Ø§ÛŒØª Ø¯Ø± Ø­Ø§Ù„ Ø¨Ø±ÙˆØ²Ø±Ø³Ø§Ù†ÛŒ Ø§Ø³Øªâ€¦</h2>
              <p>Ù„Ø·ÙØ§Ù‹ Ú†Ù†Ø¯ Ù„Ø­Ø¸Ù‡ Ø¨Ø¹Ø¯ Ø¯ÙˆØ¨Ø§Ø±Ù‡ ØªÙ„Ø§Ø´ Ú©Ù†ÛŒØ¯.</p>
            </body>
          </html>
          "@ | Out-File "maintenance/app_offline.htm" -Encoding UTF8

      # 1) Ù†ØµØ¨ WinSCP
      - name: ğŸ”§ Install WinSCP
        shell: pwsh
        run: |
          choco install winscp -y
          & "C:\Program Files (x86)\WinSCP\WinSCP.com" /help | Out-Null

      # 2) STOP: ÙÙ‚Ø· Ø¢Ù¾Ù„ÙˆØ¯ app_offline.htm (Ù‡ÛŒÚ† Ø­Ø°Ù/Ø³ÛŒÙ†Ú©ÛŒ Ø§Ù†Ø¬Ø§Ù… Ù†Ù…ÛŒâ€ŒØ´ÙˆØ¯)
      - name: ğŸ›‘ Stop App (upload app_offline.htm) - NO DELETE
        shell: pwsh
        run: |
          $localFile = Resolve-Path "maintenance/app_offline.htm"

          $script = @"
          option batch abort
          option confirm off
          open ftp://ewan:mahan1384@@ftp.api.pardistous.ir/
          put "$localFile" "/app_offline.htm"
          exit
          "@

          $script | Out-File "winscp_stop.txt" -Encoding ASCII
          & "C:\Program Files (x86)\WinSCP\WinSCP.com" /ini=nul /log=winscp_stop.log /script=winscp_stop.txt

          if ($LASTEXITCODE -ne 0) {
            Get-Content winscp_stop.log
            throw "WinSCP stop failed"
          }

      - name: â³ Wait for IIS unload
        shell: pwsh
        run: Start-Sleep -Seconds 10

      # 3) BUILD
      - name: ğŸ”¨ Build API
        shell: pwsh
        run: |
          dotnet publish Endpoints/Api/Api.csproj -c Release -o ./publish/api

      # 4) Ø¢Ù…Ø§Ø¯Ù‡â€ŒØ³Ø§Ø²ÛŒ ÙØ§ÛŒÙ„â€ŒÙ‡Ø§ÛŒ Deploy + Ø³Ø§Ø®Øª web.config
      - name: ğŸ“¦ Prepare deployment
        shell: pwsh
        run: |
          if (Test-Path deployment) { Remove-Item deployment -Recurse -Force }
          New-Item -ItemType Directory -Path deployment | Out-Null
          Copy-Item publish/api/* deployment/ -Recurse -Force
          New-Item -ItemType Directory -Path deployment/logs -Force | Out-Null

          @'
          <?xml version="1.0" encoding="utf-8"?>
          <configuration>
            <location path="." inheritInChildApplications="false">
              <system.webServer>
                <handlers>
                  <add name="aspNetCore" path="*" verb="*" modules="AspNetCoreModuleV2" resourceType="Unspecified" />
                </handlers>

                <aspNetCore processPath="dotnet"
                            arguments=".\Api.dll"
                            stdoutLogEnabled="true"
                            stdoutLogFile=".\logs\stdout"
                            hostingModel="inprocess">
                  <environmentVariables>
                    <environmentVariable name="ASPNETCORE_ENVIRONMENT" value="Production" />
                    <environmentVariable name="ConnectionStrings__DefaultConnection"
                                        value="Server=localhost;Database=pardisto_api;User Id=mahan;Password=ewan1384@;TrustServerCertificate=True;" />
                  </environmentVariables>
                </aspNetCore>

                <httpProtocol>
                  <customHeaders>
                    <add name="X-Content-Type-Options" value="nosniff" />
                    <add name="X-Frame-Options" value="DENY" />
                    <add name="X-XSS-Protection" value="1; mode=block" />
                    <add name="Referrer-Policy" value="strict-origin-when-cross-origin" />
                  </customHeaders>
                </httpProtocol>

                <security>
                  <requestFiltering>
                    <requestLimits maxAllowedContentLength="104857600" />
                  </requestFiltering>
                </security>
              </system.webServer>
            </location>
          </configuration>
          '@ | Out-File -FilePath "deployment/web.config" -Encoding UTF8

      # 5) DEPLOY:
      # - dangerous-clean-slate=true ØªØ§ ÙØ§ÛŒÙ„â€ŒÙ‡Ø§ÛŒÛŒ Ú©Ù‡ Ø¯Ø± Ù„ÙˆÚ©Ø§Ù„ Ù†ÛŒØ³ØªÙ†Ø¯ Ø­Ø°Ù Ø´ÙˆÙ†Ø¯
      # - ÙˆÙ„ÛŒ Ø¨Ø§ exclude Ø·ÙˆØ±ÛŒ Ù‚ÙÙ„ Ù…ÛŒâ€ŒÚ©Ù†ÛŒÙ… Ú©Ù‡ ÙÙ‚Ø· app_offline.htm Ù‡Ø¯Ù Ø­Ø°Ù Ø¨Ø§Ø´Ø¯ Ùˆ Ù‡ÛŒÚ† ÙØ§ÛŒÙ„ Ø¯ÛŒÚ¯Ø±ÛŒ Ø¯Ø³Øª Ù†Ø®ÙˆØ±Ø¯
      - name: ğŸš€ Deploy API (and remove app_offline.htm)
        uses: SamKirkland/FTP-Deploy-Action@v4.3.4
        with:
          server: ftp.api.pardistous.ir
          username: ewan
          password: mahan1384@
          local-dir: ./deployment/
          server-dir: /
          timeout: 180000
          dangerous-clean-slate: true
          exclude: |
            **/.well-known/**
            **/logs/**
            **/Uploads/**
            **/upload/**
            **/uploads/**
            **/App_Data/**
            **/wwwroot/**
            **/*.log
            **/*.txt
            # Ù…Ù‡Ù…: ÙÙ‚Ø· Ø§ÛŒÙ† ÙØ§ÛŒÙ„ Ø¨Ø§ÛŒØ¯ Ø­Ø°Ù Ø´ÙˆØ¯ Ø§Ú¯Ø± Ø±ÙˆÛŒ Ø³Ø±ÙˆØ± Ù‡Ø³Øª Ùˆ Ø¯Ø± Ù„ÙˆÚ©Ø§Ù„ Ù†ÛŒØ³Øª
            # (Ù…Ø§ Ø¹Ù…Ø¯Ø§Ù‹ app_offline.htm Ø±Ø§ Ø¯Ø± deployment Ù†Ø¯Ø§Ø±ÛŒÙ…)
            !app_offline.htm

      - name: â³ Wait for startup
        shell: pwsh
        run: Start-Sleep -Seconds 40

      - name: ğŸ“Š Final Report
        shell: pwsh
        run: |
          Write-Host "ğŸ‰ Deploy completed successfully!"
          Write-Host "API: https://api.pardistous.ir"
          Write-Host "Swagger: https://api.pardistous.ir/swagger"
