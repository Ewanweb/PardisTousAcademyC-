<!DOCTYPE html>
<html lang="fa" dir="rtl">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Ù…Ø´Ø§Ù‡Ø¯Ù‡ Ù„Ø§Ú¯â€ŒÙ‡Ø§ÛŒ Ø³ÛŒØ³ØªÙ…</title>
    <style>
      body {
        font-family: "Segoe UI", Tahoma, Geneva, Verdana, sans-serif;
        margin: 0;
        padding: 20px;
        background-color: #f5f5f5;
        direction: rtl;
      }
      .container {
        max-width: 1200px;
        margin: 0 auto;
        background: white;
        border-radius: 8px;
        box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
        padding: 20px;
      }
      .header {
        border-bottom: 2px solid #007bff;
        padding-bottom: 15px;
        margin-bottom: 20px;
      }
      .controls {
        display: flex;
        gap: 10px;
        margin-bottom: 20px;
        flex-wrap: wrap;
      }
      .controls select,
      .controls input,
      .controls button {
        padding: 8px 12px;
        border: 1px solid #ddd;
        border-radius: 4px;
        font-size: 14px;
      }
      .controls button {
        background-color: #007bff;
        color: white;
        cursor: pointer;
        border: none;
      }
      .controls button:hover {
        background-color: #0056b3;
      }
      .log-content {
        background-color: #1e1e1e;
        color: #d4d4d4;
        padding: 15px;
        border-radius: 4px;
        font-family: "Courier New", monospace;
        font-size: 12px;
        line-height: 1.4;
        max-height: 600px;
        overflow-y: auto;
        white-space: pre-wrap;
        direction: ltr;
        text-align: left;
      }
      .error {
        color: #ff6b6b;
      }
      .warning {
        color: #ffa500;
      }
      .info {
        color: #4dabf7;
      }
      .debug {
        color: #69db7c;
      }
      .loading {
        text-align: center;
        padding: 20px;
        color: #666;
      }
      .file-list {
        display: grid;
        grid-template-columns: repeat(auto-fill, minmax(300px, 1fr));
        gap: 10px;
        margin-bottom: 20px;
      }
      .file-item {
        background: #f8f9fa;
        padding: 10px;
        border-radius: 4px;
        border: 1px solid #dee2e6;
        cursor: pointer;
      }
      .file-item:hover {
        background: #e9ecef;
      }
      .file-item.selected {
        background: #007bff;
        color: white;
      }
      .stats {
        display: flex;
        gap: 20px;
        margin-bottom: 20px;
      }
      .stat-item {
        background: #f8f9fa;
        padding: 10px 15px;
        border-radius: 4px;
        text-align: center;
      }
      .stat-value {
        font-size: 24px;
        font-weight: bold;
        color: #007bff;
      }
    </style>
  </head>
  <body>
    <div class="container">
      <div class="header">
        <h1>ğŸ” Ù…Ø´Ø§Ù‡Ø¯Ù‡ Ù„Ø§Ú¯â€ŒÙ‡Ø§ÛŒ Ø³ÛŒØ³ØªÙ… Ù¾Ø±Ø¯ÛŒØ³</h1>
        <p>Ù…Ø´Ø§Ù‡Ø¯Ù‡ Ùˆ Ø¬Ø³ØªØ¬Ùˆ Ø¯Ø± Ù„Ø§Ú¯â€ŒÙ‡Ø§ÛŒ Ø³ÛŒØ³ØªÙ… Ø¨Ø±Ø§ÛŒ Ø¹ÛŒØ¨â€ŒÛŒØ§Ø¨ÛŒ Ùˆ Ù†Ø¸Ø§Ø±Øª</p>
      </div>

      <div class="stats" id="stats">
        <div class="stat-item">
          <div class="stat-value" id="totalFiles">-</div>
          <div>ÙØ§ÛŒÙ„ Ù„Ø§Ú¯</div>
        </div>
        <div class="stat-item">
          <div class="stat-value" id="totalLines">-</div>
          <div>Ø®Ø· Ù„Ø§Ú¯</div>
        </div>
        <div class="stat-item">
          <div class="stat-value" id="lastUpdate">-</div>
          <div>Ø¢Ø®Ø±ÛŒÙ† Ø¨Ø±ÙˆØ²Ø±Ø³Ø§Ù†ÛŒ</div>
        </div>
      </div>

      <div class="controls">
        <select id="logLevel">
          <option value="">Ù‡Ù…Ù‡ Ø³Ø·ÙˆØ­</option>
          <option value="Error">Ø®Ø·Ø§ (Error)</option>
          <option value="Warning">Ù‡Ø´Ø¯Ø§Ø± (Warning)</option>
          <option value="Information">Ø§Ø·Ù„Ø§Ø¹Ø§Øª (Info)</option>
          <option value="Debug">Ø¯ÛŒØ¨Ø§Ú¯ (Debug)</option>
        </select>

        <input type="text" id="searchQuery" placeholder="Ø¬Ø³ØªØ¬Ùˆ Ø¯Ø± Ù„Ø§Ú¯â€ŒÙ‡Ø§..." />
        <input
          type="number"
          id="maxLines"
          value="100"
          min="10"
          max="1000"
          placeholder="ØªØ¹Ø¯Ø§Ø¯ Ø®Ø·"
        />

        <button onclick="loadLogFiles()">ğŸ”„ Ø¨Ø±ÙˆØ²Ø±Ø³Ø§Ù†ÛŒ</button>
        <button onclick="searchLogs()">ğŸ” Ø¬Ø³ØªØ¬Ùˆ</button>
        <button onclick="loadRecentErrors()">âš ï¸ Ø®Ø·Ø§Ù‡Ø§ÛŒ Ø§Ø®ÛŒØ±</button>
        <button onclick="clearContent()">ğŸ—‘ï¸ Ù¾Ø§Ú© Ú©Ø±Ø¯Ù†</button>
      </div>

      <div class="file-list" id="fileList"></div>

      <div class="log-content" id="logContent">
        <div class="loading">Ø¯Ø± Ø­Ø§Ù„ Ø¨Ø§Ø±Ú¯Ø°Ø§Ø±ÛŒ ÙØ§ÛŒÙ„â€ŒÙ‡Ø§ÛŒ Ù„Ø§Ú¯...</div>
      </div>
    </div>

    <script>
      let selectedFile = null;
      let authToken =
        localStorage.getItem("authToken") ||
        prompt("Ù„Ø·ÙØ§Ù‹ ØªÙˆÚ©Ù† Ø§Ø­Ø±Ø§Ø² Ù‡ÙˆÛŒØª Ø±Ø§ ÙˆØ§Ø±Ø¯ Ú©Ù†ÛŒØ¯:");

      if (authToken && !authToken.startsWith("Bearer ")) {
        authToken = "Bearer " + authToken;
      }

      const apiHeaders = {
        Authorization: authToken,
        "Content-Type": "application/json",
      };

      async function apiCall(url, options = {}) {
        try {
          const response = await fetch(url, {
            ...options,
            headers: { ...apiHeaders, ...options.headers },
          });

          if (!response.ok) {
            throw new Error(`HTTP ${response.status}: ${response.statusText}`);
          }

          return await response.json();
        } catch (error) {
          console.error("API Error:", error);
          document.getElementById(
            "logContent"
          ).innerHTML = `<div style="color: #ff6b6b;">Ø®Ø·Ø§ Ø¯Ø± Ø§Ø±ØªØ¨Ø§Ø· Ø¨Ø§ API: ${error.message}</div>`;
          throw error;
        }
      }

      async function loadLogFiles() {
        try {
          const data = await apiCall("/api/logs/files");

          const fileList = document.getElementById("fileList");
          const stats = document.getElementById("stats");

          if (data.files && data.files.length > 0) {
            fileList.innerHTML = data.files
              .map(
                (file) => `
                        <div class="file-item" onclick="selectFile('${
                          file.name
                        }')">
                            <strong>${file.name}</strong><br>
                            <small>Ø­Ø¬Ù…: ${formatFileSize(
                              file.size
                            )} | Ø¢Ø®Ø±ÛŒÙ† ØªØºÛŒÛŒØ±: ${formatDate(
                  file.lastModified
                )}</small>
                        </div>
                    `
              )
              .join("");

            document.getElementById("totalFiles").textContent =
              data.files.length;
            document.getElementById("lastUpdate").textContent = formatDate(
              data.files[0]?.lastModified
            );
          } else {
            fileList.innerHTML =
              '<div class="file-item">Ù‡ÛŒÚ† ÙØ§ÛŒÙ„ Ù„Ø§Ú¯ÛŒ ÛŒØ§ÙØª Ù†Ø´Ø¯</div>';
            document.getElementById("totalFiles").textContent = "0";
          }

          document.getElementById("logContent").innerHTML =
            "ÙØ§ÛŒÙ„ Ù„Ø§Ú¯ Ù…ÙˆØ±Ø¯ Ù†Ø¸Ø± Ø±Ø§ Ø§Ù†ØªØ®Ø§Ø¨ Ú©Ù†ÛŒØ¯";
        } catch (error) {
          document.getElementById(
            "fileList"
          ).innerHTML = `<div class="file-item" style="color: red;">Ø®Ø·Ø§ Ø¯Ø± Ø¨Ø§Ø±Ú¯Ø°Ø§Ø±ÛŒ ÙØ§ÛŒÙ„â€ŒÙ‡Ø§: ${error.message}</div>`;
        }
      }

      async function selectFile(fileName) {
        selectedFile = fileName;

        // Update UI
        document
          .querySelectorAll(".file-item")
          .forEach((item) => item.classList.remove("selected"));
        event.target.closest(".file-item").classList.add("selected");

        await loadFileContent(fileName);
      }

      async function loadFileContent(fileName) {
        const maxLines = document.getElementById("maxLines").value;
        document.getElementById("logContent").innerHTML =
          '<div class="loading">Ø¯Ø± Ø­Ø§Ù„ Ø¨Ø§Ø±Ú¯Ø°Ø§Ø±ÛŒ...</div>';

        try {
          const data = await apiCall(
            `/api/logs/content/${fileName}?lines=${maxLines}`
          );

          const coloredContent = colorizeLogContent(data.content);
          document.getElementById("logContent").innerHTML = coloredContent;
          document.getElementById("totalLines").textContent = data.totalLines;
        } catch (error) {
          document.getElementById(
            "logContent"
          ).innerHTML = `<div style="color: #ff6b6b;">Ø®Ø·Ø§ Ø¯Ø± Ø¨Ø§Ø±Ú¯Ø°Ø§Ø±ÛŒ ÙØ§ÛŒÙ„: ${error.message}</div>`;
        }
      }

      async function searchLogs() {
        const query = document.getElementById("searchQuery").value.trim();
        if (!query) {
          alert("Ù„Ø·ÙØ§Ù‹ Ù…ØªÙ† Ø¬Ø³ØªØ¬Ùˆ Ø±Ø§ ÙˆØ§Ø±Ø¯ Ú©Ù†ÛŒØ¯");
          return;
        }

        document.getElementById("logContent").innerHTML =
          '<div class="loading">Ø¯Ø± Ø­Ø§Ù„ Ø¬Ø³ØªØ¬Ùˆ...</div>';

        try {
          const url = selectedFile
            ? `/api/logs/search?query=${encodeURIComponent(
                query
              )}&fileName=${selectedFile}`
            : `/api/logs/search?query=${encodeURIComponent(query)}`;

          const data = await apiCall(url);

          if (data.results && data.results.length > 0) {
            const content = data.results
              .map(
                (result) =>
                  `[${result.fileName}:${result.lineNumber}] ${result.content}`
              )
              .join("\n");

            document.getElementById("logContent").innerHTML =
              colorizeLogContent(content);
          } else {
            document.getElementById("logContent").innerHTML =
              "Ù†ØªÛŒØ¬Ù‡â€ŒØ§ÛŒ ÛŒØ§ÙØª Ù†Ø´Ø¯";
          }
        } catch (error) {
          document.getElementById(
            "logContent"
          ).innerHTML = `<div style="color: #ff6b6b;">Ø®Ø·Ø§ Ø¯Ø± Ø¬Ø³ØªØ¬Ùˆ: ${error.message}</div>`;
        }
      }

      async function loadRecentErrors() {
        const level = document.getElementById("logLevel").value || "Error";
        document.getElementById("logContent").innerHTML =
          '<div class="loading">Ø¯Ø± Ø­Ø§Ù„ Ø¨Ø§Ø±Ú¯Ø°Ø§Ø±ÛŒ Ø®Ø·Ø§Ù‡Ø§ÛŒ Ø§Ø®ÛŒØ±...</div>';

        try {
          const data = await apiCall(
            `/api/logs/recent?level=${level}&hours=24`
          );

          if (data.logs && data.logs.length > 0) {
            const content = data.logs
              .map((log) => `[${log.fileName}] ${log.content}`)
              .join("\n");

            document.getElementById("logContent").innerHTML =
              colorizeLogContent(content);
          } else {
            document.getElementById(
              "logContent"
            ).innerHTML = `Ù‡ÛŒÚ† Ù„Ø§Ú¯ ${level} Ø¯Ø± 24 Ø³Ø§Ø¹Øª Ú¯Ø°Ø´ØªÙ‡ ÛŒØ§ÙØª Ù†Ø´Ø¯`;
          }
        } catch (error) {
          document.getElementById(
            "logContent"
          ).innerHTML = `<div style="color: #ff6b6b;">Ø®Ø·Ø§ Ø¯Ø± Ø¨Ø§Ø±Ú¯Ø°Ø§Ø±ÛŒ: ${error.message}</div>`;
        }
      }

      function colorizeLogContent(content) {
        return content
          .replace(/\[ERR\]|\[ERROR\]/g, '<span class="error">$&</span>')
          .replace(/\[WRN\]|\[WARNING\]/g, '<span class="warning">$&</span>')
          .replace(/\[INF\]|\[INFORMATION\]/g, '<span class="info">$&</span>')
          .replace(/\[DBG\]|\[DEBUG\]/g, '<span class="debug">$&</span>');
      }

      function clearContent() {
        document.getElementById("logContent").innerHTML = "Ù…Ø­ØªÙˆØ§ Ù¾Ø§Ú© Ø´Ø¯";
        document.getElementById("searchQuery").value = "";
      }

      function formatFileSize(bytes) {
        if (bytes === 0) return "0 Bytes";
        const k = 1024;
        const sizes = ["Bytes", "KB", "MB", "GB"];
        const i = Math.floor(Math.log(bytes) / Math.log(k));
        return parseFloat((bytes / Math.pow(k, i)).toFixed(2)) + " " + sizes[i];
      }

      function formatDate(dateString) {
        return new Date(dateString).toLocaleString("fa-IR");
      }

      // Auto-refresh every 30 seconds
      setInterval(loadLogFiles, 30000);

      // Load files on page load
      loadLogFiles();
    </script>
  </body>
</html>
